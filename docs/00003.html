<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN">
<html>
<head>
<title>bm64_a2dp_hfp</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Doc-O-Matic" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <link rel="STYLESHEET" href="default.css" type="text/css" />

<script type="text/javascript" src="scripts.js"></script>
</head>
<body class="Element700" onload="onBodyLoadEx('frames.html', 'topic', '00003.html');" onmousedown="onBodyMouseDown();">

<!-- Begin Popups -->

<!-- End Popups -->

<!-- Begin Page Header -->
<div class="Element710" id="areafixed">
<div class="Element94">
<a href="00001.html" target="topic">Bluetooth Demonstrations</a> &gt; <a href="00002.html" target="topic">BM64 and BM71 Driver Demonstrations</a> &gt; <a href="00003.html" target="topic">bm64_a2dp_hfp</a></div>
<div class="Element92">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element1">
MPLAB Harmony Bluetooth Help</div>
</td><td width="25%">
<div class="Element2">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00020.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element90">
<a href="00002.html" target="topic">Previous</a> | <a href="00002.html" target="topic">Up</a> | <a href="00004.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element96">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: APPS BLUETOOTH BM64_a2dp_hfp Topic Title: bm64_a2dp_hfp)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table><div class="Element5">
bm64_a2dp_hfp</div>
</div>
</div>

<!-- End Page Header -->

<!-- Begin Client Area -->
<div class="Element720" id="areascroll">
<div class="Element721">

<!-- Begin Page Content -->
<a name="PageContent"></a><div class="Element58">
<a name="4465736372697074696F6E"></a><div class="Element11">
<div class="Element10">
<p class="Element10">
In this demonstration application, a BM64 Module Daughter Board is used to stream A2DP audio from a Bluetooth host, such as a smartphone, to a pair of headphones connected to a codec daughter board attached to the same development board.&nbsp;</p>
<p class="Element10">
The demonstration can also automatically answer a voice call coming in via Hands-Free Protocol (HFP), interrupting (and pausing) any A2DP streaming in progress. Local audio is input using a microphone connected to the MIC IN input of the BM64 Module Daughter Board. When the call is terminated, streaming resumes.&nbsp;</p>
<p class="Element10">
&nbsp;</p><div class="Element15">
Architecture</div>
<p class="Element10">
There are two different projects packaged in this application.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<u>PIC32_MX Bluetooth Audio Development Kit Project:</u>&nbsp;</p>
<p class="Element10">
One project runs on the Bluetooth Audio Development Kit (BTADK). It uses the microcontroller installed on the board, namely the PIC32MX470F512L with 512 KB of Flash memory and 128 KB of RAM running at 96 MHz. The BTADK includes the following features:</p>
<ul class="Element630">
<li class="Element600">Six push buttons (SW1-SW6, SW2 and SW6 are not used)</li>
<li class="Element600">Five LEDs (D5-D9)</li>
<li class="Element600">Two X32 sockets, one of which is used for the BM64 Bluetooth module, and the other for a AK4954 codec.</li>
</ul><p class="Element10">
The BTADK also includes an LCD display and USB interfaces, none of which are used in this project. </p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table0">
<tr>
<td class="Element67" valign="top" width="10%" style="border:none;">
<div class="Element68">
<img src="Note Icon.png" border="0" alt="" title=""> <strong>Note:</strong>&nbsp;</div></td><td class="Element67" valign="top" width="90%" style="border:none;">
<div class="Element68">
The PIC32 Bluetooth Audio Development Kit does not include the BM64 Bluetooth Module Daughter Board or the AK4954 Codec Daughter Board. They must be purchased separately from microchipDIRECT, part number AC320032-3 and AC324954, respectively.&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
The program takes up to approximately 13% (67 KB) of the microcontroller’s program space, and 3% (3 KB) of the RAM. No heap is used.&nbsp;</p>
<p class="Element10">
The following figure illustrates the application architecture: </p><p class="Element10" style="text-align: center;">
<img src="APPS BT bm64_a2dp_hfp BTADK Application Diagram.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
&nbsp;</p>
<p class="Element10" style="text-align: center;">
&nbsp;</p><p class="Element10">
<u>PIC32 MZ EF Curiosity 2.0 Project:</u>&nbsp;</p>
<p class="Element10">
One project runs on the PIC32 MZ EF Curiosity 2.0 board, using the PIC32MZ2048EFM144 microcontroller with 2 MB of Flash memory and 512 KB of RAM running at 198 MHz. The PIC32 MZ EF Curiosity 2.0 board includes the following features:</p>
<ul class="Element630">
<li class="Element600">Four push buttons (SW1-SW4)</li>
<li class="Element600">Four LEDs (LED1-LED4)</li>
<li class="Element600">Two X32 sockets, one of which is used for the BM64 Bluetooth module, and the other for a AK4954 codec.</li>
</ul><p class="Element10">
The PIC32 MZ EF Curiosity 2.0 board also includes an LCD display and USB interfaces, none of which are used in this project. </p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table0">
<tr>
<td class="Element67" valign="top" width="10%" style="border:none;">
<div class="Element68">
<img src="Note Icon.png" border="0" alt="" title=""> <strong>Note:</strong>&nbsp;</div></td><td class="Element67" valign="top" width="90%" style="border:none;">
<div class="Element68">
The PIC32 MZ EF Curiosity 2.0 board does not include the BM64 Bluetooth Module Daughter Board or the AK4954 Codec Daughter Board. They must be purchased separately from microchipDIRECT, part number AC320032-3 and AC324954, respectively.&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
The program takes up to approximately 1% (16 KB) of the PIC32MZ2048EFM144 microcontroller’s program space, and 1% (2.5 KB) of the RAM. No heap is used.&nbsp;</p>
<p class="Element10">
The following figure illustrates the application architecture: </p><p class="Element10" style="text-align: center;">
<img src="APPS BT bm64_a2dp_hfp PIC32 MZ C2 Application Diagram.png" border="0" alt="" title=""></p><p class="Element10">
&nbsp;</p>
<p class="Element10">
The PIC32 microcontroller (MCU) runs the application code, and communicates with the BM64 over a USART interface operating at 115,200 baud. The BM64 module contains its own Bluetooth stack, so it is unnecessary to include a software Bluetooth stack in the PIC32 MCU. The buttons and LEDs are interfaced using GPIO pins. Both the BM64 and the AK4954 codec are configured in I2S ((Inter-IC Sound) slave mode and the I2S peripheral in the PIC32 as an I2S master, generating the I2S clocks. The AK4954 codec is controlled from the PIC32 using an I2C interface.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
As with any MPLAB Harmony application, the SYS_Initialize function, which is located in the <span class="Element146">system_init.c</span> source file, makes calls to initialize various subsystems, such as the clock, ports, board support package (BSP), BM64, codec, timers, and interrupts.&nbsp;</p>
<p class="Element10">
The BM64 and codec drivers, graphics, timers, and the application state machines are all updated through calls located in the SYS_Tasks function in system_tasks.c file. Interrupt handlers in the <span class="Element146">system_interrupt.c</span> file are used for the four DMA channels (only channels 0 and 2 are used), the UART, and the two timers.&nbsp;</p>
<p class="Element10">
The application code is contained in two source files, <span class="Element146">app.c</span> and <span class="Element146">audio.c</span>. The former contains the application state machine (APP_Tasks). It first initializes the application, sets up a periodic timing callback, and then waits for the BM64 driver’s internal state machine to complete initialization (indicated by the function DRV_BT_GetPowerStatus returning RV_BT_STATUS_READY ). At that point the application calls a function called audioStart which initiates audio processing.&nbsp;</p>
<p class="Element10">
Meanwhile, the audio state machine in audio.c has received a handle to the BM64 driver by calling DRV_BT_Open, and then setting callbacks for two event handlers (AUDIO_BT_RxBufferEventHandler for buffer event handling, and _audioEventHandler for general event handling). After that it gets a handle to the codec driver by calling its DRV_CODEC_Open function with a mode of DRV_IO_INTENT_WRITE. Then it registers an event handler, AUDIO_CODEC_TxBufferEventHandler as a callback with the codec driver. Then, it waits for the application to call audioStart before it makes its first call to DRV_BT_BufferAddRead to request audio samples from the BM64.&nbsp;</p>
<p class="Element10">
The event handler callback is given control whenever a buffer has been processed. By default two sets of buffers are used (AUDIO_QUEUE_SIZE = 2), each with 1250 32-bit samples; however, simply by changing the queue size a circular buffer scheme can be used instead. As each buffer is handed off to be sent to the codec, the other one becomes available to be filled by the BM64.&nbsp;</p>
<p class="Element10">
The BM64 and codec drivers interface with their respective I2S interfaces via DMA, but this is largely transparent to the application, as it is all taken care of by MPLAB Harmony.</p><div class="Element15">
Demonstration Features</div>

<ul class="Element630">
<li class="Element600">Uses the BM64 Bluetooth Driver Library to read audio samples from the BM64</li>
<li class="Element600">Use of either a “ping-pong” or circular buffer scheme</li>
<li class="Element600">At a lower level, the BM64 driver uses the UART Driver Library to talk to the BM64 module</li>
<li class="Element600">Uses the AK4954 Codec Driver Library to write samples to the AK4954 Codec</li>
<li class="Element600">At a lower level, using the I2S Driver Library between the BM64 and BM64 driver, and the AK4954 Codec Library and the AK4954 Codec</li>
<li class="Element600">Use of “ping-pong” audio buffers</li>
<li class="Element600">Sending and receiving characters between the UART of the PIC32 MCU and the BM64 (see UART Driver Library)</li>
<li class="Element600">Processing of button pushes on the PIC32 Bluetooth Audio Development Kit using a state machine for contact debouncing (see Ports Peripheral Library)</li>
<li class="Element600">Use of two timers: one as a periodic 1 ms timer for the application, and a second used by the BM64 driver (see Timer Driver Library)</li>
</ul><p class="Element10">
&nbsp;</p>
<div class="Element15">
Tools Setup Differences</div>
<p class="Element10">
<u>For the projects using the PIC32MX:</u>&nbsp;</p>
<p class="Element10">
When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <i>File &gt; New Project</i>. Chose the Configuration name the based on the BSP. Select the appropriate processor (PIC32MX470F512L).&nbsp;</p>
<p class="Element10">
In MHC, under Available Components select the BSP PIC32MX Bluetooth Audio Development Kit. Under Bluetooth<i>-&gt;Templates</i>, double-click on BM64 I2S Bluetooth. Answer Yes to all questions.&nbsp;</p>
<p class="Element10">
You should end up with a project graph that looks like this, after rearranging the boxes: </p><p class="Element10" style="text-align: center;">
<img src="a2dp hfp BM64 BTADK project graph.png" border="0" alt="" title=""></p><p class="Element10">
&nbsp;</p>
<p class="Element10">
<u>For projects using the PIC32MZ:</u>&nbsp;</p>
<p class="Element10">
When building a new application, start by creating a 32-bit MPLAB Harmony 3 project in MPLAB X IDE by selecting <i>File &gt; New Project</i>. Chose the Configuration name the based on the BSP. Select the appropriate processor (PIC32MZ2048EFM144).&nbsp;</p>
<p class="Element10">
In MHC, under Available Components select the BSP PIC32MZ EF Curiosity 2.0. Under Bluetooth<i>-&gt;Templates</i>, double-click on BM64 I2S Bluetooth. Answer Yes to all questions.&nbsp;</p>
<p class="Element10">
You should end up with a project graph that looks like this, after rearranging the boxes: </p><p class="Element10" style="text-align: center;">
<img src="a2dp hfp BM64 PIC32 MZ C2 project graph.png" border="0" alt="" title=""></p><p class="Element10">
Open the <i>Harmony Configurator Framework &gt; Drivers</i> section, and then expand <i>Bluetooth &gt; BM64</i> and select <i>Use BM64 Driver?</i>. A sub-menu will appear with all options selected. Since you will only be using HFP, A2DP, and AVRCP protocols, clear the BLE Features? check box. Leaving the HFP, A2DP, AVRCP Protocols selected will by default bring in the drivers for both the codec and the I2S (and I2C driver, if using the AK4954).</p></div>
</div>
<a name="546F70696373"></a><div class="Element14">
Topics</div>
<div class="Element11">
<div class="Element10">
<div class="Element212">
<div class="TableDiv">
<table cellspacing="0" class="Table1">
<tr>
<td class="Element200" valign="top" width="35%">
<div class="Element201">
Name&nbsp;</div></td><td class="Element204" valign="top" width="65%">
<div class="Element205">
Description&nbsp;</div></td></tr><tr>
<td class="Element202" valign="top" width="35%">
<div class="Element203">
<a href="00004.html" target="topic">Building the Application</a>&nbsp;</div></td><td class="Element206" valign="top" width="65%">
<div class="Element207">
This section identifies the MPLAB X IDE project name and location and lists and describes the available configurations for the Bluetooth Demonstration.&nbsp;</div></td></tr><tr>
<td class="Element202" valign="top" width="35%">
<div class="Element203">
<a href="00005.html" target="topic">Configuring the Hardware</a>&nbsp;</div></td><td class="Element206" valign="top" width="65%">
<div class="Element207">
This section describes how to configure the supported hardware.&nbsp;</div></td></tr><tr>
<td class="Element202" valign="top" width="35%">
<div class="Element203">
<a href="00006.html" target="topic">Running the Demonstration</a>&nbsp;</div></td><td class="Element206" valign="top" width="65%">
<div class="Element207">
This section describes how to run the demonstration.&nbsp;</div></td></tr></table></div></div>
</div>
</div>
</div>
<!-- End Page Content -->

<!-- Begin Page Footer -->
<div class="Element95">
<a href="00001.html" target="topic">Bluetooth Demonstrations</a> &gt; <a href="00002.html" target="topic">BM64 and BM71 Driver Demonstrations</a> &gt; <a href="00003.html" target="topic">bm64_a2dp_hfp</a></div>
<div class="Element93">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element3">
MPLAB Harmony Bluetooth Help</div>
</td><td width="25%">
<div class="Element4">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00020.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element91">
<a href="00002.html" target="topic">Previous</a> | <a href="00002.html" target="topic">Up</a> | <a href="00004.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element97">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: APPS BLUETOOTH BM64_a2dp_hfp Topic Title: bm64_a2dp_hfp)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table></div>

<!-- End Page Footer -->
</div>
</div>

<!-- End Client Area -->
</body></html>